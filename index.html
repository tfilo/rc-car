<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>RC-Car</title>
        <style>
            * {
                user-select: none;
            }
            html,
            body {
                margin: 0;
                padding: 4px;
                width: 100%;
                height: 100%;
                background: white;
                overflow: hidden;
                touch-action: none;
                -ms-touch-action: none;
            }
            .up,
            .down,
            .left,
            .right,
            .stop,
            .horn {
                position: absolute;
                border-radius: 16px;
                font-size: xx-large;
                font-weight: 900;
                color: black;
                touch-action: manipulation;
                background-color: lightgray;
                user-select: none;
            }
            .up,
            .down,
            .left,
            .right {
                width: 28%;
                height: 40%;
            }
            .up {
                top: 5%;
                left: 36%;
                border: 4px solid green;
            }
            .down {
                bottom: 5%;
                left: 36%;
                border: 4px solid blue;
            }
            .left {
                top: 30%;
                left: 5%;
                border: 4px solid black;
            }
            .right {
                top: 30%;
                right: 5%;
                border: 4px solid black;
            }
            .horn,
            .stop {
                width: min(20vw, 20vh);
                height: min(20vw, 20vh);
                border: 4px solid black;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .horn {
                top: 8%;
                right: 5%;
            }
            .stop {
                bottom: 8%;
                right: 5%;
                color: red;
                font-size: large;
            }
            .status,
            .battery,
            .controls {
                position: absolute;
                left: 4px;
                font-size: small;
                display: flex;
                flex-direction: column;
            }
            .status {
                top: 4px;
            }
            .battery {
                left: auto;
                right: 4px;
                flex-direction: row;
                gap: 4px;
            }
            .controls {
                bottom: 4px;
            }
            .controls_label {
                display: inline-block;
                width: 70px;
            }
            .controls_raw_value {
                display: inline-block;
                padding-left: 8px;
            }
        </style>
        <script>
            const HORN_OFF = 0;
            const HORN_ON = 1;
            const WAIT_MS = 50;
            const S_MIN = 0;
            const S_MAX = 100;
            let steering = S_MAX / 2;
            const REVERSE = -1;
            const FORWARD_MIN = 1;
            const FORWARD_MAX = 3;
            const STOP = 0;
            let drive = STOP;
            let hasError = false;
            let requestCount = 0;
            let totalElapsedTime = 0;
            let horn = HORN_OFF;

            function forward() {
                if (drive === REVERSE) {
                    drive = STOP;
                } else {
                    drive = Math.min(drive + 1, FORWARD_MAX);
                }
            }
            function reverse() {
                if (drive > STOP) {
                    drive = Math.max(drive - 1, STOP);
                } else {
                    drive = REVERSE;
                }
            }

            function stop() {
                drive = STOP;
            }

            function left() {
                steering = Math.max(steering - 10, S_MIN);
            }
            function right() {
                steering = Math.min(steering + 10, S_MAX);
            }

            let horntimeout = null;
            function honk() {
                horn = HORN_ON;
                clearTimeout(horntimeout);
                horntimeout = setTimeout(() => {
                    horn = HORN_OFF;
                }, 500);
            }

            async function send() {
                const startTime = Date.now();
                let elapsedTime = 0;
                try {
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), 200);
                    const res = await fetch(`/control?steering=${steering}&drive=${drive}&horn=${horn}`, {
                        method: 'POST',
                        signal: controller.signal
                    });
                    elapsedTime = Date.now() - startTime;
                    document.getElementById('status').innerHTML = res.status;
                    if (res.ok) {
                        res.json().then((data) => {
                            const rawBattery = data.battery;
                            if (rawBattery && !isNaN(+rawBattery)) {
                                const batteryVoltage = (+rawBattery).toFixed(2);
                                document.getElementById('battery').innerHTML = batteryVoltage;
                            }
                        });
                    }
                } catch (error) {
                    document.getElementById('status').innerHTML = error.name;
                } finally {
                    requestCount++;
                    totalElapsedTime += elapsedTime;
                    setTimeout(() => {
                        send();
                    }, Math.min(Math.max(0, WAIT_MS - elapsedTime), WAIT_MS));
                }
            }

            setInterval(() => {
                document.getElementById('requestCount').innerHTML = requestCount;
                document.getElementById('elapsedTime').innerHTML = Math.round(totalElapsedTime / requestCount) + ' ms';
                requestCount = 0;
                totalElapsedTime = 0;
            }, 1000);

            setInterval(() => {
                document.getElementById('drive').value = drive + 1;
                document.getElementById('steering').value = steering;
                document.getElementById('drive_value').innerHTML = drive;
                document.getElementById('steering_value').innerHTML = steering - 50;
                document.getElementById('horn').style.backgroundColor = horn === HORN_ON ? 'orange' : 'lightgray';
                document.getElementById('up').style.backgroundColor = drive > 0 ? 'lightgreen' : 'lightgray';
                document.getElementById('brake').style.backgroundColor = drive === REVERSE ? 'lightblue' : 'lightgray';
                document.getElementById('left').style.backgroundColor = steering < S_MAX / 2 ? 'gray' : 'lightgray';
                document.getElementById('right').style.backgroundColor = steering > S_MAX / 2 ? 'gray' : 'lightgray';
            }, 100);
        </script>
    </head>
    <body onload="send()">
        <div class="status">
            <span>Status: <span id="status"></span></span>
            <span>Request: <span id="elapsedTime">0</span>; <span id="requestCount">0</span> req/s</span>
        </div>
        <div class="battery">Battery: <span id="battery">0</span> V</div>
        <div class="controls">
            <span>
                <span class="controls_label">Drive:</span>
                <progress id="drive" value="1" max="4"></progress>
                <span id="drive_value" class="controls_raw_value">0</span>
            </span>
            <span>
                <span class="controls_label">Steering:</span>
                <progress id="steering" value="50" max="100"></progress>
                <span id="steering_value" class="controls_raw_value">0</span>
            </span>
        </div>
        <div>
            <button id="horn" class="horn" onclick="honk()">&#128264;</button>
            <button id="up" class="up" onclick="forward()">&#8593;</button>
            <button id="brake" class="down" onclick="reverse()">&#8595;</button>
            <button id="left" class="left" onclick="left()">&#8592;</button>
            <button id="right" class="right" onclick="right()">&#8594;</button>
            <button class="stop" onclick="stop()">STOP</button>
        </div>
    </body>
</html>
